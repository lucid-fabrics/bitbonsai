---
title: 'License API'
description: 'License management and subscription backend'
icon: 'key'
---

## Overview

<CardGroup cols={2}>
  <Card title="Type" icon="code">
    NestJS REST API
  </Card>
  <Card title="Framework" icon="n">
    NestJS 11
  </Card>
  <Card title="Database" icon="database">
    PostgreSQL 15+
  </Card>
  <Card title="Port" icon="network-wired">
    3200
  </Card>
</CardGroup>

**Responsibilities:**
- License key generation/validation (Ed25519 signatures)
- Payment webhooks (Stripe, Patreon, Ko-fi)
- Pricing API for website
- Email notifications (Resend)

---

## Architecture

```
apps/license-api/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ pricing/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pricing.controller.ts  # GET /api/pricing (public)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pricing.service.ts     # Business logic
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ licenses/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ licenses.controller.ts # License CRUD (admin)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ licenses.service.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ crypto.service.ts      # Ed25519 encryption
‚îÇ   ‚îú‚îÄ‚îÄ stripe/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ stripe.controller.ts   # Webhook handler
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ stripe.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ security/
‚îÇ       ‚îú‚îÄ‚îÄ admin-api-key.guard.ts
‚îÇ       ‚îî‚îÄ‚îÄ rate-limit.guard.ts
‚îî‚îÄ‚îÄ prisma/
    ‚îú‚îÄ‚îÄ schema.prisma
    ‚îî‚îÄ‚îÄ migrations/
```

---

## API Endpoints

### Public Endpoints

<Card title="GET /api/pricing" icon="dollar-sign">
  **Fetch active pricing tiers** - No authentication required

  **Rate Limit:** 100 requests/60s per IP

  **CORS:** Enabled for `bitbonsai.io`, `app.bitbonsai.io`
</Card>

<CodeGroup>
```bash cURL
curl https://api.bitbonsai.io/api/pricing
```

```typescript Response
[
  {
    "id": "cm3abc123",
    "name": "FREE",
    "displayName": "Free",
    "description": "Perfect for hobbyists",
    "maxNodes": 1,
    "maxConcurrentJobs": 2,
    "priceMonthly": 0,
    "priceYearly": null,
    "stripePriceIdMonthly": null,
    "isActive": true
  },
  {
    "id": "cm3def456",
    "name": "SUPPORTER",
    "displayName": "Supporter",
    "maxNodes": 5,
    "maxConcurrentJobs": 10,
    "priceMonthly": 500,      // $5.00 (cents)
    "priceYearly": 5000,      // $50.00 (2 months free)
    "stripePriceIdMonthly": "price_1A2B3C",
    "isActive": true
  }
]
```
</CodeGroup>

---

### Admin Endpoints

<Warning>
Admin endpoints require `X-API-KEY` header authentication
</Warning>

#### POST /api/admin/licenses

Generate new license key

<CodeGroup>
```bash Request
curl -X POST https://api.bitbonsai.io/api/admin/licenses \
  -H "X-API-KEY: your-admin-api-key" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "tierId": "cm3def456",
    "expiresAt": "2026-12-31T23:59:59Z"
  }'
```

```json Response
{
  "id": "cm4xyz789",
  "licenseKey": "BITBONSAI-PAT-eyJlbWFpbCI6InRlc3...",
  "email": "user@example.com",
  "tier": {
    "name": "PATREON_PRO",
    "displayName": "Patreon Pro"
  },
  "status": "ACTIVE",
  "expiresAt": "2026-12-31T23:59:59Z"
}
```
</CodeGroup>

#### GET /api/admin/licenses/:email

Fetch licenses by email

```bash
curl -H "X-API-KEY: your-admin-api-key" \
  https://api.bitbonsai.io/api/admin/licenses/user@example.com
```

#### DELETE /api/admin/licenses/:id

Revoke license (soft delete)

```bash
curl -X DELETE \
  -H "X-API-KEY: your-admin-api-key" \
  https://api.bitbonsai.io/api/admin/licenses/cm4xyz789
```

---

## Ed25519 Keypair Security

<Warning>
If the keypair is lost, **all existing licenses become invalid**. Backup keys immediately!
</Warning>

### Keypair Location

Keys stored in: `./keys/` (relative to app root)

```
./keys/
‚îú‚îÄ‚îÄ private.pem  (üîí NEVER COMMIT)
‚îú‚îÄ‚îÄ public.pem   (‚úÖ Safe to share)
```

### Automatic Generation

On first startup, API auto-generates Ed25519 keypair if none exists:

```typescript
// apps/license-api/src/crypto/crypto.service.ts
async loadOrGenerateKeys() {
  if (!fs.existsSync(privateKeyPath)) {
    this.logger.log('Generating new Ed25519 keypair');
    const { publicKey, privateKey } = crypto.generateKeyPairSync('ed25519');
    // Saves to ./keys/
  }
}
```

### Backup Procedures

<Tabs>
  <Tab title="Development">
    ```bash
    # Backup keys directory
    cp -r ./keys ./keys.backup

    # Store in secure location (NOT in git)
    cp -r ./keys ~/secure-backups/bitbonsai-license-keys-$(date +%F)
    ```

    <Note>
    **DO NOT** commit keys to git:
    ```bash
    git add ./keys  # ‚ùå NEVER DO THIS
    ```
    </Note>
  </Tab>

  <Tab title="Production">
    **Use secret management service:**

    | Platform | Service |
    |----------|---------|
    | **AWS** | AWS Secrets Manager + S3 |
    | **Azure** | Azure Key Vault |
    | **Google Cloud** | Google Secret Manager |
    | **Self-Hosted** | HashiCorp Vault |

    **Backup Script:**
    ```bash
    #!/bin/bash
    DATE=$(date +%Y-%m-%d-%H%M%S)
    BACKUP_DIR="/secure/backups/license-keys"

    mkdir -p "$BACKUP_DIR"
    tar -czf "$BACKUP_DIR/license-keys-$DATE.tar.gz" -C ./keys .

    # Upload to S3
    aws s3 cp "$BACKUP_DIR/license-keys-$DATE.tar.gz" \
      s3://bitbonsai-secrets/license-keys/ \
      --server-side-encryption AES256
    ```

    **Cron (daily backup):**
    ```cron
    0 3 * * * /path/to/backup-license-keys.sh
    ```
  </Tab>
</Tabs>

### Health Check

Verify keypair exists:

```bash
curl http://localhost:3200/health
```

<CodeGroup>
```json Response (OK)
{
  "status": "ok",
  "crypto": {
    "keysLoaded": true,
    "algorithm": "ed25519"
  }
}
```

```json Response (Error)
{
  "status": "error",
  "crypto": {
    "keysLoaded": false,
    "error": "Keypair not found"
  }
}
```
</CodeGroup>

### Recovery Procedure

<Steps>
  <Step title="Stop API Immediately">
    ```bash
    docker stop license-api
    # or
    pm2 stop license-api
    ```
  </Step>

  <Step title="Restore from Backup">
    ```bash
    # Extract backup
    tar -xzf license-keys-YYYY-MM-DD.tar.gz -C ./keys

    # Verify permissions
    chmod 600 ./keys/private.pem
    chmod 644 ./keys/public.pem
    ```
  </Step>

  <Step title="Restart & Verify">
    ```bash
    # Restart API
    docker start license-api

    # Verify health
    curl http://localhost:3200/health
    ```
  </Step>
</Steps>

<Warning>
If no backup exists: **All licenses must be re-issued**. This is catastrophic - avoid at all costs!
</Warning>

---

## Development Setup

<Steps>
  <Step title="Start PostgreSQL">
    ```bash
    docker run -d \
      --name bitbonsai-postgres \
      -p 5432:5432 \
      -e POSTGRES_DB=bitbonsai_licenses \
      -e POSTGRES_USER=postgres \
      -e POSTGRES_PASSWORD=postgres \
      postgres:15
    ```
  </Step>

  <Step title="Generate Prisma Client">
    ```bash
    cd apps/license-api
    npx prisma generate
    ```
  </Step>

  <Step title="Run Migrations">
    ```bash
    npx prisma migrate dev
    ```
  </Step>

  <Step title="Setup Environment">
    Create `apps/license-api/.env.local`:

    ```bash
    # Database
    LICENSE_DATABASE_URL="postgresql://postgres:postgres@localhost:5432/bitbonsai_licenses"

    # Encryption (64 hex chars)
    ENCRYPTION_KEY="$(openssl rand -hex 32)"

    # Admin API Key
    ADMIN_API_KEY="$(openssl rand -base64 32)"

    # Stripe (test mode)
    STRIPE_SECRET_KEY="sk_test_51A2B3C..."
    STRIPE_WEBHOOK_SECRET="whsec_abc123..."

    # Email
    RESEND_API_KEY="re_dummy_for_dev"

    # Server
    LICENSE_API_PORT=3200
    NODE_ENV=development
    ```
  </Step>

  <Step title="Start Dev Server">
    ```bash
    nx serve license-api
    ```
    Access at **http://localhost:3200/api/pricing**
  </Step>
</Steps>

---

## License Key Format

```
BITBONSAI-{TIER}-{PAYLOAD}.{SIGNATURE}
```

**Example:**
```
BITBONSAI-PAT-eyJlbWFpbCI6InRlc3RAZXhhbXBsZS5jb20iLCJ0aWVyIjoiUEFUUkVPTl9QUk8i...
```

**Decoded Payload:**
```json
{
  "email": "test@example.com",
  "tier": "PATREON_PRO",
  "maxNodes": 5,
  "maxConcurrentJobs": 10,
  "expiresAt": null,
  "issuedAt": "2025-12-25T12:00:00Z"
}
```

<Info>
Signatures use **Ed25519** (quantum-resistant, 32-byte keys)
</Info>

---

## Stripe Integration

### Webhook Setup

<Steps>
  <Step title="Create Webhook">
    In Stripe Dashboard:
    - **URL:** `https://api.bitbonsai.io/api/stripe/webhook`
    - **Events:** `checkout.session.completed`, `customer.subscription.*`, `invoice.payment_failed`
  </Step>

  <Step title="Copy Webhook Secret">
    Add to environment variables:
    ```bash
    STRIPE_WEBHOOK_SECRET="whsec_..."
    ```
  </Step>

  <Step title="Test Locally">
    ```bash
    stripe listen --forward-to localhost:3200/api/stripe/webhook
    ```
  </Step>
</Steps>

### Subscription Flow

```mermaid
sequenceDiagram
    User->>Website: Click "Subscribe"
    Website->>Stripe: Create Checkout Session
    Stripe-->>User: Redirect to payment page
    User->>Stripe: Complete payment
    Stripe->>License API: Webhook: checkout.session.completed
    License API->>License API: Generate license key
    License API->>User: Email license key (Resend)
    User->>BitBonsai App: Activate license
```

---

## Security

<CardGroup cols={2}>
  <Card title="Webhook Verification" icon="shield-check">
    Timing-safe signature comparison
  </Card>
  <Card title="Deduplication" icon="ban-bug">
    Idempotency for webhook events
  </Card>
  <Card title="Rate Limiting" icon="gauge-high">
    30 req/min on webhooks
  </Card>
  <Card title="Ed25519 Signatures" icon="lock">
    Quantum-resistant encryption
  </Card>
</CardGroup>

---

## Troubleshooting

<AccordionGroup>
  <Accordion title="Database Connection Failed" icon="database">
    **Symptom:** `Can't reach database server`

    **Fix:**
    ```bash
    # Check PostgreSQL
    docker ps | grep postgres

    # Test connection
    psql -h localhost -U postgres -d bitbonsai_licenses

    # Verify DATABASE_URL
    cat apps/license-api/.env.local | grep DATABASE_URL
    ```
  </Accordion>

  <Accordion title="Encryption Key Error" icon="key">
    **Symptom:** `ENCRYPTION_KEY must be 64 hex characters`

    **Fix:**
    ```bash
    # Generate valid key (64 hex = 32 bytes)
    openssl rand -hex 32

    # Update .env.local
    echo "ENCRYPTION_KEY=$(openssl rand -hex 32)" >> apps/license-api/.env.local
    ```
  </Accordion>

  <Accordion title="Missing Prisma Client" icon="code">
    **Symptom:** `Cannot find module '@prisma/client'`

    **Fix:**
    ```bash
    cd apps/license-api
    npx prisma generate
    nx build license-api
    ```
  </Accordion>

  <Accordion title="Webhook Signature Failed" icon="webhook">
    **Symptom:** `Webhook signature verification failed`

    **Fix:**
    1. Check webhook secret matches provider dashboard
    2. Test locally:
    ```bash
    stripe listen --forward-to localhost:3200/api/stripe/webhook
    ```
    3. Use signing secret from CLI output
  </Accordion>
</AccordionGroup>

---

## Related Documentation

<CardGroup cols={2}>
  <Card title="Website Integration" icon="globe" href="/development/website">
    Marketing site using pricing API
  </Card>
  <Card title="Main Backend" icon="server" href="/development/backend">
    BitBonsai transcoding backend
  </Card>
</CardGroup>
